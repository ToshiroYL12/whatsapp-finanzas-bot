// src/bot.js
import 'dotenv/config';
import pkg from 'whatsapp-web.js';
const { Client, LocalAuth } = pkg;
import qrcode from 'qrcode-terminal';
import { handleAdminMessage } from './admin.js';
import { getSubscriber, appendMovimiento, setSubscriberFields, listUserCategories, addCategoryToUserSheet } from './sheets.js';
import { driveClient } from './googleAuth.js';
import { setupUserDashboard } from './sheets.js';
import { isAdmin } from './utils.js';

/** --------- Helpers --------- **/

// Normaliza a +51XXXXXXXXX (ajusta si usas otro pa√≠s)
function normPhone(raw) {
  const digits = (raw || '').replace(/[^\d+]/g, '');
  if (digits.startsWith('+')) return digits;
  if (digits.length === 9) return '+51' + digits; // 9 d√≠gitos locales ‚Üí +51
  if (digits.length === 11 && digits.startsWith('51')) return '+' + digits;
  return digits;
}

// ¬øMensaje viene de grupo?
function isGroupJid(jid) {
  return typeof jid === 'string' && jid.endsWith('@g.us');
}

// Fecha local Lima YYYY-MM-DD
function todayLima() {
  const fmt = new Intl.DateTimeFormat('es-PE', {
    timeZone: 'America/Lima',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  });
  // "dd/mm/aaaa" ‚Üí transformamos a aaaa-mm-dd
  const parts = fmt.formatToParts(new Date());
  const d = parts.find(p => p.type === 'day').value.padStart(2, '0');
  const m = parts.find(p => p.type === 'month').value.padStart(2, '0');
  const y = parts.find(p => p.type === 'year').value;
  return `${y}-${m}-${d}`;
}

// Genera ID simple y √∫nico por tiempo
function genId() {
  const now = Date.now().toString(36);
  const rnd = Math.floor(Math.random() * 1e6).toString(36);
  return `${now}${rnd}`.toUpperCase();
}

// Parseo de monto robusto: acepta "10,50" o "10.50" o "S/ 10,50"
function parseMonto(raw) {
  if (!raw) return NaN;
  // quitar s√≠mbolos y espacios
  let s = String(raw).replace(/[^\d,.\-]/g, '').trim();
  // Si hay ambas coma y punto, intentamos asumir coma = miles, punto = decimales
  if (s.includes(',') && s.includes('.')) {
    // quita separador de miles m√°s probable (coma)
    if (s.indexOf(',') < s.indexOf('.')) {
      s = s.replace(/,/g, '');
    } else {
      s = s.replace(/\./g, '').replace(',', '.');
    }
  } else if (s.includes(',')) {
    // solo coma ‚Üí usar como decimal
    s = s.replace(',', '.');
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

// Email b√°sico
function isValidEmail(s) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s || '').trim());
}

// Estado conversacional para onboarding de suscriptores
const userState = new Map(); // key: from (jid), value: { step: 'ASK_EMAIL'|'ASK_NAME'|'MENU'|'CAT'|'CAT_NEW'|'MONTO'|'CONFIRM', tipo, categorias, categoria, monto }

async function ensureUserSheetProvisioned(sub) {
  if (sub?.sheet_id) return sub;
  const templateId = process.env.USER_TEMPLATE_SHEET_ID;
  if (!templateId) throw new Error('USER_TEMPLATE_SHEET_ID no configurado');
  const drive = await driveClient();
  const displayName = (sub?.nombre ? String(sub.nombre) : '') || String(sub?.telefono || '').trim() || 'Usuario';
  const res = await drive.files.copy({
    fileId: templateId,
    requestBody: { name: `Finanzas - ${displayName}` },
    supportsAllDrives: true,
  });
  const newId = res.data.id;
  const url = `https://docs.google.com/spreadsheets/d/${newId}/edit`;
  await setSubscriberFields(sub.telefono, { sheet_id: newId, sheet_url: url });
  sub.sheet_id = newId;
  sub.sheet_url = url;
  try {
    await setupUserDashboard(newId);
  } catch (e) {
    console.warn('[DASHBOARD INIT] No se pudo inicializar Dashboard:', e?.message);
  }
  // Compartir si hay email
  if (sub.email && isValidEmail(sub.email)) {
    await drive.permissions.create({
      fileId: newId,
      requestBody: { role: 'reader', type: 'user', emailAddress: sub.email },
      sendNotificationEmail: false,
      supportsAllDrives: true,
    });
  }
  return sub;
}

// Mensaje de ayuda para usuario
function ayudaUsuario() {
  return [
    'üìí *Registro r√°pido*',
    '',
    '‚Ä¢ *gasto* <monto> [categoria] [detalle]',
    '  ej:  gasto 25.50 comida almuerzo',
    '',
    '‚Ä¢ *ingreso* <monto> [categoria] [detalle]',
    '  ej:  ingreso 1200 sueldo septiembre',
    '',
    '_Formato flexible: acepta 10,50 o 10.50_',
  ].join('\n');
}

/** --------- App logic --------- **/

const client = new Client({
  // Permite cambiar la ruta de sesi√≥n con SESSION_DIR (ej. "/data/session")
  authStrategy: new LocalAuth({ dataPath: process.env.SESSION_DIR || '.wwebjs_auth' }),
  puppeteer: {
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  },
});

client.on('qr', (qr) => {
  console.log('‚ö†Ô∏è Escanea este QR para vincular WhatsApp:');
  qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
  console.log('‚úÖ WhatsApp bot listo.');
});

client.on('auth_failure', (m) => {
  console.error('‚ùå Falla de autenticaci√≥n:', m);
});

client.on('disconnected', (reason) => {
  console.warn('üîå Desconectado:', reason);
});

client.on('message', async (message) => {
  try {
    const from = message.from || '';
    const body = (message.body || '').trim();

    // Ignorar grupos
    if (isGroupJid(from)) return;

    // Flujo ADMIN: solo si es el administrador
    if (isAdmin(from)) {
      await handleAdminMessage(message);
      return;
    }

    // Guard de autorizaci√≥n
    let sub = await getSubscriber(from);
    const autorizado = isAdmin(from) || (sub && String(sub.autorizado || '').toUpperCase() === 'TRUE');

    if (!autorizado) {
      // No responder a no autorizados (silencio absoluto)
      return;
    }

    // Onboarding suscriptor: pedir email, crear/compartir sheet, pedir nombre
    // 1) Email
    if (!sub?.email || !isValidEmail(sub.email)) {
      const st = userState.get(from) || { step: 'ASK_EMAIL' };
      if (st.step !== 'ASK_EMAIL' && /^.+@.+\..+$/i.test(body)) {
        // Si el usuario mand√≥ un email sin estar en el paso, tr√°talo como email
        st.step = 'ASK_EMAIL';
      }
      if (st.step === 'ASK_EMAIL') {
        if (isValidEmail(body)) {
          await setSubscriberFields(from, { email: body.trim() });
          // Refrescar suscriptor en memoria
          sub = await getSubscriber(from);
          userState.set(from, { step: 'ASK_NAME' });
          await message.reply('Listo. Guard√© tu correo. Ahora, ¬øc√≥mo quieres que te llame? (tu nombre)');
          // Intentar provisionar sheet ya con email
          try {
            await ensureUserSheetProvisioned(sub);
          } catch (e) {
            console.error('[PROVISION ERROR][email step]', e);
          }
          return;
        } else {
          userState.set(from, { step: 'ASK_EMAIL' });
          await message.reply('Para empezar, env√≠a tu correo electr√≥nico (ej: nombre@dominio.com)');
          return;
        }
      }
    }

    // 2) Sheet provisioning si falta
    if (!sub?.sheet_id) {
      try {
        await ensureUserSheetProvisioned(sub);
        // Refrescar suscriptor en memoria
        sub = await getSubscriber(from);
        await message.reply(`He creado tu Excel y lo compart√≠ contigo. Accede aqu√≠: ${sub.sheet_url}`);
      } catch (e) {
        console.error('[PROVISION ERROR]', e);
        await message.reply('No pude crear/compartir tu Excel. Informa al administrador.');
        return;
      }
    }

    // 3) Nombre si falta
    if (!sub?.nombre || !String(sub.nombre).trim()) {
      const st = userState.get(from) || { step: 'ASK_NAME' };
      if (st.step === 'ASK_NAME') {
        if (body.length >= 2 && !/^(gasto|ingreso)\b/i.test(body)) {
          const nombre = body.trim().slice(0, 60);
          await setSubscriberFields(from, { nombre });
          sub = await getSubscriber(from);
          userState.delete(from);
          await message.reply(`Perfecto, ${nombre}. Ya est√°s listo.`);
          // Contin√∫a al flujo normal tras nombrar
        } else {
          userState.set(from, { step: 'ASK_NAME' });
          await message.reply('¬øC√≥mo quieres que te llame? (env√≠a tu nombre)');
          return;
        }
      } else {
        userState.set(from, { step: 'ASK_NAME' });
        await message.reply('¬øC√≥mo quieres que te llame? (env√≠a tu nombre)');
        return;
      }
    }

    // A partir de aqu√≠, el usuario ya est√° listo para registrar movimientos
    // Men√∫ guiado: 1) Ingreso 2) Gasto -> Categor√≠a -> Monto -> Confirmaci√≥n

    // Atajos globales de navegaci√≥n
    if (/^(0|menu)$/i.test(body)) {
      userState.set(from, { step: 'MENU' });
      await message.reply(['¬øQu√© deseas registrar?', '1) Ingreso', '2) Gasto'].join('\n'));
      return;
    }

    const st = userState.get(from) || { step: 'MENU' };
    if (st.step === 'MENU') {
      if (body === '1' || body === '2') {
        st.tipo = body === '1' ? 'INGRESO' : 'GASTO';
        // cargar categor√≠as desde hoja del usuario
        const cats = await listUserCategories(sub.sheet_id, st.tipo);
        st.categorias = cats;
        st.step = 'CAT';
        userState.set(from, st);
        await message.reply([
          `Selecciona categor√≠a para ${st.tipo}:`,
          ...cats.map((c, i) => `${i + 1}) ${c}`),
          '99) Agregar nueva categor√≠a',
          '',
          '0) Men√∫'
        ].join('\n'));
        return;
      }
      // Mostrar men√∫ si no opci√≥n v√°lida
      userState.set(from, { step: 'MENU' });
      await message.reply(['¬øQu√© deseas registrar?', '1) Ingreso', '2) Gasto'].join('\n'));
      return;
    }

    if (st.step === 'CAT') {
      if (body === '99') {
        st.step = 'CAT_NEW';
        userState.set(from, st);
        await message.reply(`Escribe el nombre de la nueva categor√≠a para ${st.tipo}:
0) Men√∫`);
        return;
      }
      const idx = Number(body) - 1;
      if (Number.isInteger(idx) && idx >= 0 && st.categorias && idx < st.categorias.length) {
        st.categoria = st.categorias[idx];
        st.step = 'MONTO';
        userState.set(from, st);
        await message.reply('Ingresa el monto (ej: 120, 120.50):\n0) Men√∫');
        return;
      }
      await message.reply('Elige una opci√≥n v√°lida de la lista o 0 para volver al men√∫.');
      return;
    }

    if (st.step === 'CAT_NEW') {
      const nombre = body.trim().slice(0, 60);
      if (!nombre) {
        await message.reply('Nombre inv√°lido. Env√≠a un nombre para la categor√≠a o 0 para men√∫.');
        return;
      }
      try {
        await addCategoryToUserSheet(sub.sheet_id, st.tipo, nombre);
        st.categoria = nombre;
        st.step = 'MONTO';
        userState.set(from, st);
        await message.reply(`Categor√≠a '${nombre}' lista. Ingresa el monto (ej: 120, 120.50):\n0) Men√∫`);
      } catch (e) {
        console.error('[CAT_NEW ERROR]', e);
        await message.reply('No pude agregar la categor√≠a. Intenta de nuevo o usa 0 para volver al men√∫.');
      }
      return;
    }

    if (st.step === 'MONTO') {
      const m = parseMonto(body);
      if (!Number.isFinite(m)) {
        await message.reply('Monto inv√°lido. Intenta de nuevo (ej: 120, 120.50).\n0) Men√∫');
        return;
      }
      st.monto = st.tipo === 'GASTO' ? -Math.abs(m) : Math.abs(m);
      st.step = 'CONFIRM';
      userState.set(from, st);
      await message.reply([
        'Vas a registrar:',
        `‚Ä¢ Tipo: ${st.tipo}`,
        `‚Ä¢ Categor√≠a: ${st.categoria}`,
        `‚Ä¢ Monto: ${st.monto}`,
        '',
        '¬øConfirmas? 1) S√≠, 2) No'
      ].join('\n'));
      return;
    }

    if (st.step === 'CONFIRM') {
      if (body === '1') {
        const movimiento = {
          id: genId(),
          fecha: todayLima(),
          tipo: st.tipo,
          categoria: st.categoria,
          monto: st.monto,
          detalle: '',
        };
        try {
          await appendMovimiento(sub.sheet_id, movimiento);
          await message.reply(['‚úÖ Registrado', `‚Ä¢ Tipo: ${movimiento.tipo}`, `‚Ä¢ Monto: ${movimiento.monto}`, `‚Ä¢ Categor√≠a: ${movimiento.categoria}`, `‚Ä¢ Fecha: ${movimiento.fecha}`, `‚Ä¢ ID: ${movimiento.id}`, '', '0) Men√∫'].join('\n'));
        } catch (e) {
          console.error('[APPEND ERROR]', e);
          await message.reply('‚ö†Ô∏è No se pudo registrar el movimiento. Informa al administrador.');
        }
        userState.set(from, { step: 'MENU' });
        return;
      }
      // No/Cancelar
      userState.set(from, { step: 'MENU' });
      await message.reply('Cancelado. Volviendo al men√∫...\n1) Ingreso\n2) Gasto');
      return;
    }

    // Comandos de usuario: gasto / ingreso
    if (/^(gasto|ingreso)\b/i.test(body)) {
      const parts = body.split(/\s+/);
      const tipo = parts.shift().toLowerCase(); // 'gasto' o 'ingreso'

      // Esperado: <monto> [categoria] [detalle...]
      const rawMonto = parts.shift();
      const monto = parseMonto(rawMonto);

      if (!Number.isFinite(monto)) {
        await message.reply('‚ö†Ô∏è Debes indicar un *monto* v√°lido.\nEj: *gasto 25.50 comida almuerzo*\n\n' + ayudaUsuario());
        return;
      }

      const categoria = parts.shift() || (tipo === 'gasto' ? 'Gasto' : 'Ingreso');
      const detalle = parts.length ? parts.join(' ') : '';

      // Si es gasto, monto negativo; si es ingreso, positivo
      const montoSign = tipo === 'gasto' ? -Math.abs(monto) : Math.abs(monto);

      // Obtener sheet del usuario desde Suscriptores
      const userSheetId = sub?.sheet_id;
      if (!userSheetId) {
        await message.reply('‚ö†Ô∏è No encuentro tu *sheet_id* en Suscriptores. Pide al admin provisionarte (copiar plantilla).');
        return;
      }

      const movimiento = {
        id: genId(),
        fecha: todayLima(),
        tipo: tipo.toUpperCase(),     // GASTO / INGRESO
        categoria,
        monto: montoSign,
        detalle,
      };

      try {
        await appendMovimiento(userSheetId, movimiento);
        await message.reply(
          [
            '‚úÖ *Registrado*',
            `‚Ä¢ Tipo: ${movimiento.tipo}`,
            `‚Ä¢ Monto: ${montoSign}`,
            `‚Ä¢ Categor√≠a: ${categoria}`,
            `‚Ä¢ Detalle: ${detalle || '‚Äî'}`,
            `‚Ä¢ Fecha: ${movimiento.fecha}`,
            `‚Ä¢ ID: ${movimiento.id}`,
          ].join('\n')
        );
      } catch (e) {
        console.error('[APPEND ERROR]', e);
        await message.reply('‚ùå No se pudo guardar en *Movimientos*. Revisa tu acceso a la hoja y comenta al admin.');
      }
      return;
    }

    // Si no coincide con nada, muestra ayuda
    if (body.length) {
      await message.reply(ayudaUsuario());
    }
  } catch (err) {
    console.error('[BOT ERROR]', err);
    try {
      await message.reply('‚ö†Ô∏è Ocurri√≥ un error inesperado procesando tu mensaje.');
    } catch {}
  }
});

client.initialize();

/** Graceful shutdown en Ctrl+C */
process.on('SIGINT', async () => {
  try {
    console.log('\nüëã Cerrando sesi√≥n de WhatsApp‚Ä¶');
    await client.destroy();
  } catch {}
  process.exit(0);
});
